import numpy as np
import matplotlib.pyplot as plt
from scipy.spatial import Voronoi
from shapely.geometry import Polygon

all_points = {1: (16177.168492333, 15213.6930606151), 2: (16177.9916466466, 15218.3427015971), 3: (16180.7280681681, 15223.1499157976), 4: (16183.4955430588, 15228.0111922426), 5: (16186.213851715, 15232.6548163332), 6: (16188.9622670376, 15237.4035567669), 7: (16191.7431202728, 15242.255413413), 8: (16194.5019144486, 15246.9766156487), 9: (16197.2789356306, 15251.6955328789), 10: (16200.0178450238, 15256.5621338217), 11: (16202.2168815881, 15260.3213173943), 26: (16178.5124648494, 15200.1831187038), 27: (16180.6334931027, 15204.2015914852), 28: (16183.363101034, 15208.9015013771), 29: (16186.2121696794, 15213.5530433478), 30: (16188.8640555782, 15218.4558870522), 31: (16191.6390533239, 15223.0702513605), 32: (16194.5098812088, 15228.037412283), 33: (16197.2592788046, 15232.7577046752), 34: (16199.8721529376, 15237.3747116523), 35: (16202.6553916909, 15242.2093459722), 36: (16205.4291606291, 15246.9263888644), 37: (16208.1085182506, 15251.6802504677), 38: (16210.8842136969, 15256.5296043254), 39: (16213.6912098252, 15261.2641264871), 40: (16216.4194336587, 15266.0589306429), 41: (16221.1831974635, 15269.1825893447), 60: (16183.4245422141, 15189.7360812072), 61: (16186.1490127855, 15194.4907588726), 62: (16188.8765774679, 15199.2881040061), 63: (16191.6943350556, 15204.1361391731), 64: (16194.3518245053, 15208.7784046307), 65: (16197.2016541017, 15213.6716421843), 66: (16199.9513130592, 15218.2823236771), 67: (16202.7263921588, 15223.1996273324), 68: (16205.5689786443, 15227.9040458752), 69: (16208.1881702571, 15232.7416967088), 70: (16211.0344843325, 15237.4790768363), 71: (16213.7300886187, 15242.1908814739), 72: (16216.4295995375, 15246.94992314), 73: (16219.1181356647, 15251.8590353224), 74: (16221.9549428712, 15256.4990729364), 75: (16224.6628165111, 15261.2932436625), 76: (16227.4218387017, 15266.007795888), 77: (16230.2129528219, 15270.7247047108), 78: (16233.0776821806, 15275.6366254194), 79: (16236.8962906052, 15277.5457572602), 103: (16188.9728858866, 15180.4229362085), 104: (16191.6366469888, 15185.0548138274), 105: (16194.3037846221, 15189.7895234646), 106: (16197.0827051102, 15194.4891049471), 107: (16199.8886348249, 15199.3624531124), 108: (16202.5434324127, 15204.0745910918), 109: (16205.4484448912, 15208.7667270591), 110: (16208.1085144561, 15213.552594129), 111: (16210.9703319755, 15218.4014764577), 112: (16213.6820622265, 15223.1968016401), 113: (16216.4921521641, 15228.0608041883), 114: (16219.2314819952, 15232.7501099305), 115: (16221.974073329, 15237.5634028818), 116: (16224.6138694112, 15242.251883667), 117: (16227.400480221, 15246.925524083), 118: (16230.2306844984, 15251.6510629375), 119: (16232.9353663197, 15256.495505875), 120: (16235.662261501, 15261.260971874), 121: (16238.4128793065, 15266.051204389), 122: (16241.1911874749, 15270.8908920363), 123: (16244.0146553142, 15275.460178433), 124: (16246.7523732138, 15280.3081161873), 125: (16249.4574803832, 15285.0588873532), 126: (16254.2893259673, 15287.4987025149), 152: (16198.1435976078, 15177.3375121709), 153: (16199.8776115224, 15180.3639916088), 154: (16202.6503593256, 15185.0087205917), 155: (16205.3494385643, 15189.7776634479), 156: (16208.0575125967, 15194.5867138524), 157: (16210.9840730503, 15199.5250898171), 158: (16213.7097586769, 15204.0363838794), 159: (16216.4865101791, 15208.8775376612), 160: (16219.2954866427, 15213.6823798688), 161: (16221.9776248674, 15218.3684062017), 162: (16224.5996838915, 15223.0570276715), 163: (16227.4620164023, 15227.9432198796), 164: (16230.025235895, 15232.6869307812), 165: (16232.8535399052, 15237.3795115305), 166: (16235.6474177539, 15242.2318184402), 167: (16238.526296291, 15247.1023270264), 168: (16241.1301281652, 15251.6773610162), 169: (16243.9679946701, 15256.6158675328), 170: (16246.5224486717, 15261.3088362524), 171: (16249.4286929012, 15266.0962093472), 172: (16252.1317125967, 15270.8905582931), 173: (16255.0600746686, 15275.6867819726), 174: (16257.428291654, 15280.2260030294), 175: (16260.4195748653, 15285.0292890426), 176: (16263.155865406, 15289.9574959464), 177: (16265.5589374673, 15292.0388528602), 204: (16206.8896341691, 15173.5066882009), 205: (16208.3043149377, 15175.5464137318), 206: (16210.9641312917, 15180.326902872), 207: (16213.662795635, 15185.1614860023), 208: (16216.3388689867, 15189.795292208), 209: (16219.2129488187, 15194.6077399151), 210: (16222.0250002158, 15199.4354162859), 211: (16224.6575868776, 15204.1183885802), 212: (16227.3273666871, 15208.8823493868), 213: (16230.181702255, 15213.6348917577), 214: (16233.0000497281, 15218.5248948382), 215: (16235.7297395038, 15223.3235436808), 216: (16238.4363094588, 15227.9628124479), 217: (16241.2391656654, 15232.6605525194), 218: (16244.0459244889, 15237.3528990746), 219: (16246.6872684662, 15242.2414840581), 220: (16249.4930993223, 15247.0021033743), 221: (16252.1685065432, 15251.6247804184), 222: (16254.8088451913, 15256.4038591338), 223: (16257.7848534568, 15261.265228753), 224: (16260.5292254564, 15266.0235566534), 225: (16263.1221791184, 15270.7100171428), 226: (16266.0027728037, 15275.632045106), 227: (16268.7158265709, 15280.2237628615), 228: (16271.5462746493, 15284.9236963876), 229: (16274.2871933648, 15289.909307573), 230: (16277.0385960643, 15294.58303307), 231: (16279.066804292, 15298.3425717661), 260: (16248.2760423937, 15230.0320447851), 261: (16252.6982835446, 15233.4703537226), 262: (16255.051162963, 15237.6105674058), 263: (16257.6917707388, 15242.2929235427), 264: (16260.4705918951, 15246.997192367), 265: (16263.1624006855, 15251.8470765604), 266: (16265.8760231115, 15256.5482391696), 267: (16268.5995309749, 15261.2717176639), 268: (16271.3915239266, 15266.0837574629), 269: (16274.2009751129, 15270.8667680966), 270: (16276.9419212666, 15275.6631772686), 271: (16279.7062836063, 15280.2866322398), 272: (16282.4660356382, 15285.1586708622), 273: (16285.2309860892, 15289.9338991987), 274: (16287.9136586607, 15294.6431702608), 275: (16290.610088266, 15299.4057621192), 291: (16264.2691283023, 15234.6511211945), 292: (16265.8708309883, 15237.4372297442), 293: (16268.68980943, 15242.1880709361), 294: (16271.4812108914, 15246.9460258754), 295: (16274.126455101, 15251.6903019641), 296: (16276.990238742, 15256.44817024), 297: (16279.6280700497, 15261.2110133124), 298: (16282.4896431156, 15265.9425803479), 299: (16285.2035097374, 15270.9101356091), 300: (16287.8741951534, 15275.4111845084), 301: (16290.6938570545, 15280.387405714), 302: (16293.4091675253, 15285.0734515134), 303: (16296.2170565543, 15289.9252797719), 304: (16298.8572933447, 15294.6346537173), 305: (16301.7327856041, 15299.4644174175), 321: (16275.2178343189, 15234.6046971735), 322: (16276.8281776234, 15237.502051292), 323: (16279.7020190794, 15242.2183286455), 324: (16282.3862381027, 15246.9497560086), 325: (16285.1524488579, 15251.7837541075), 326: (16287.9379776105, 15256.5733061125), 327: (16290.6573199331, 15261.2569979727), 328: (16293.4359429459, 15266.0716618421), 329: (16296.122144559, 15270.8931627059), 330: (16298.8883112317, 15275.5924738292), 331: (16301.7086531392, 15280.3658348117), 332: (16304.4366475869, 15285.0260425648), 333: (16307.1125558155, 15289.7754369779), 334: (16309.9903904464, 15294.6955979057), 335: (16312.6266885154, 15299.3538274514), 351: (16286.1795108375, 15234.5029985374), 352: (16287.7429767488, 15237.4275508244), 353: (16290.6774094835, 15242.1511680167), 354: (16293.4118663129, 15246.9978332845), 355: (16296.1785086686, 15251.6717086993), 356: (16298.9535778571, 15256.5442278814), 357: (16301.5587960123, 15261.2861139933), 358: (16304.2925901434, 15266.009840644), 359: (16307.1920034284, 15270.865558031), 360: (16309.9631501635, 15275.625163069), 361: (16312.7282122421, 15280.3795337053), 362: (16315.3284943643, 15285.112415975), 363: (16318.1054730691, 15289.7895190921), 364: (16320.8850443583, 15294.5641413359), 365: (16323.6055656949, 15299.3802047223), 381: (16297.6278050511, 15235.1588567048), 382: (16298.971532069, 15237.5911747543), 383: (16301.5525137208, 15242.211903953), 384: (16304.4214335653, 15246.9531713435), 385: (16307.1050873889, 15251.733952106), 386: (16309.9455842119, 15256.5034499373), 387: (16312.6179469837, 15261.2409832915), 388: (16315.3619906283, 15266.0334888957), 389: (16318.159412841, 15270.7474543533), 390: (16320.9482971598, 15275.6239517247), 391: (16323.8725305406, 15280.4716628762), 392: (16326.527735808, 15285.1162351388), 393: (16329.3075177408, 15290.0038086381), 394: (16331.9602553069, 15294.6720227776), 395: (16334.6783204348, 15299.3974074861), 410: (16309.9093463275, 15237.4585779924), 411: (16312.6615989741, 15242.2701453017), 412: (16315.3647107634, 15246.9452329632), 413: (16318.1708019588, 15251.7683672672), 414: (16320.8932136802, 15256.5847230386), 415: (16323.6619264706, 15261.2970519206), 416: (16326.3868185628, 15266.0426202053), 417: (16329.1455827993, 15270.7871461976), 418: (16331.9556807057, 15275.6648399336), 419: (16334.5671698572, 15280.3767123204), 420: (16337.3265661551, 15285.1376284063), 421: (16340.1715639879, 15289.9796633823), 438: (16321.9426987189, 15239.4039508151), 439: (16323.6237562431, 15242.1502673868), 440: (16326.4468077504, 15247.0545516871), 441: (16329.1071092213, 15251.7754926374), 442: (16331.8498134924, 15256.5791252218), 443: (16334.6507158334, 15261.328766075), 444: (16337.5073963959, 15266.0726840976), 445: (16340.1109412874, 15270.8092204006), 446: (16342.9129138934, 15275.5763377696), 447: (16345.6573852066, 15280.3402175279), 448: (16348.5101618991, 15285.1546986373), 422: (16342.9074830872, 15294.6616588794), 423: (16345.6220533603, 15299.3634105837), 449: (16351.1142662278, 15289.990368613), 450: (16354.0546549678, 15294.5433633979), 451: (16356.6478221762, 15299.3944259705)}
polygon = [(16321.942698718862, 15239.403950815087), (16323.623756243147, 15242.150267386809), (16326.446807750384, 15247.054551687092), (16331.849813492447, 15256.579125221815), (16334.650715833408, 15261.328766074961), (16337.507396395864, 15266.072684097646), (16340.110941287363, 15270.809220400637), (16342.912913893406, 15275.576337769628), (16345.657385206605, 15280.340217527933), (16348.510161899087, 15285.154698637316), (16351.114266227756, 15289.99036861304), (16354.054654967795, 15294.54336339794), (16356.647822176219, 15299.394425970504), (16351.138885143619, 15299.39863568265), (16345.622053360334, 15299.363410583695), (16340.133556405024, 15299.251609382221), (16334.678320434761, 15299.397407486105), (16329.164323125906, 15299.331558070144), (16323.605565694863, 15299.380204722283), (16318.237540727541, 15299.2907106271), (16312.626688515418, 15299.353827451356), (16307.21243256965, 15299.37911003269), (16301.732785604136, 15299.464417417534), (16290.610088265965, 15299.405762119219), (16285.09546432225, 15299.354938570408), (16279.066804291971, 15298.342571766116), (16257.534087848731, 15289.799892673269), (16249.457480383166, 15285.058887353165), (16241.209226682548, 15280.392442172391), (16233.077682180561, 15275.636625419367), (16228.593517199974, 15272.833266486414), (16221.183197463513, 15269.182589344678), (16216.419433658706, 15266.058930642905), (16211.893975461659, 15263.661127540281), (16208.151809132016, 15261.30005880538), (16202.216881588098, 15260.321317394264), (16200.017845023773, 15256.562133821657), (16197.27893563063, 15251.695532878859), (16194.501914448567, 15246.976615648717), (16191.743120272762, 15242.25541341305), (16188.962267037594, 15237.403556766922), (16186.21385171503, 15232.654816333205), (16183.495543058845, 15228.011192242615), (16180.728068168099, 15223.149915797636), (16177.99164664658, 15218.342701597137), (16177.168492333032, 15213.693060615104), (16178.512464849397, 15200.183118703775), (16185.063636933859, 15183.340860974042), (16188.972885886615, 15180.422936208546), (16193.374052129278, 15178.558588577434), (16206.889634169058, 15173.506688200869), (16216.375131976441, 15171.262229062615), (16216.562126295967, 15171.534047890113), (16218.042177569703, 15173.685481168328), (16221.07739485486, 15178.563082791863), (16223.837168109254, 15183.075118161736), (16226.33902968152, 15188.033568479119), (16228.84079970105, 15192.86215124279), (16232.068178546266, 15198.373450376092), (16234.595896136598, 15203.000170804558), (16237.199495684938, 15207.531582929192), (16240.317499530152, 15211.844077207146), (16243.151262652711, 15216.617888547478), (16246.05695570691, 15221.38484392315), (16248.282419574098, 15226.105658628045), (16251.714876544313, 15228.794397450982), (16256.578165423707, 15231.081015206872), (16262.095690142945, 15231.181788064538), (16267.442896258668, 15230.851723290978), (16272.897039782838, 15231.079045392571), (16278.163172137574, 15230.803296186028), (16283.927339923219, 15231.192162610589), (16289.289110553102, 15231.116129018365), (16294.824007403688, 15231.155308343468), (16300.398769748048, 15230.900565721093), (16307.48155249341, 15233.532937146721), (16313.187233340577, 15234.309961177407), (16319.207527569439, 15235.004154449967), (16319.394078624086, 15235.025665439663), (16321.942698718862, 15239.403950815087)]

def voronoi_finite_polygons_2d(vor, boundary_polygon):
    """
    Преобразует бесконечные регионы Вороного в конечные, обрезая по заданному полигону.
    """
    new_regions = []

    center = vor.points.mean(axis=0)
    radius = np.ptp(vor.points, axis=0).max()

    # Словарь: какие рёбра есть у каждой точки
    all_ridges = {}
    for (p1, p2), (v1, v2) in zip(vor.ridge_points, vor.ridge_vertices):
        all_ridges.setdefault(p1, []).append((p2, v1, v2))
        all_ridges.setdefault(p2, []).append((p1, v1, v2))

    # Обработка каждой ячейки
    for p1, region_index in enumerate(vor.point_region):
        region = vor.regions[region_index]
        if -1 not in region and len(region) > 0:
            # Конечная ячейка
            polygon = Polygon([vor.vertices[i] for i in region])
            clipped = polygon.intersection(boundary_polygon)
            if not clipped.is_empty:
                new_regions.append(clipped)
            continue

        # Ячейка с бесконечными рёбрами
        ridges = all_ridges[p1]
        region_points = []

        for p2, v1, v2 in ridges:
            if v1 >= 0 and v2 >= 0:
                region_points.append(vor.vertices[v1])
                region_points.append(vor.vertices[v2])
            else:
                # Один конец бесконечный
                v_finite = v1 if v1 >= 0 else v2
                t = vor.points[p2] - vor.points[p1]
                t /= np.linalg.norm(t)
                n = np.array([-t[1], t[0]])

                midpoint = vor.points[[p1, p2]].mean(axis=0)
                direction = np.sign(np.dot(midpoint - center, n)) * n
                far_point = vor.vertices[v_finite] + direction * radius

                region_points.append(vor.vertices[v_finite])
                region_points.append(far_point)

        try:
            region_poly = Polygon(region_points).convex_hull
            clipped = region_poly.intersection(boundary_polygon)
            if not clipped.is_empty:
                new_regions.append(clipped)
        except:
            continue

    return new_regions


# Шаг 1: подготовка данных
points = np.array(list(all_points.values()))

# Построение Вороного
vor = Voronoi(points)

# Преобразуем polygon в объект shapely Polygon
bounding_polygon = Polygon(polygon)

# Получаем обрезанные регионы
regions = voronoi_finite_polygons_2d(vor, bounding_polygon)
# Визуализация
fig, ax = plt.subplots(figsize=(10, 10))

# Отрисовка обрезанных ячеек
for poly in regions:
    if isinstance(poly, Polygon):
        x, y = poly.exterior.xy
        ax.fill(x, y, alpha=0.4, edgecolor='black')

# Точки
ax.plot(points[:, 0], points[:, 1], 'ko', markersize=2)

# Ограничивающий контур
bx, by = bounding_polygon.exterior.xy
ax.plot(bx, by, 'r-', linewidth=1.5, label='Ограничение')

plt.axis('equal')
plt.title("Обрезанные ячейки диаграммы Вороного по полигону")
plt.legend()
plt.show()
